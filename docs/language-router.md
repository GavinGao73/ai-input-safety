语言路由架构（Language Router）v2026-03

状态：Active
适用范围：Web 版本（GitHub 部署）
性质：可替换实现层（非系统级不变量）

一、目的

语言路由模块用于判断：

输入内容应当使用哪个语言规则包（EN / DE / ZH / 未来语言）。

该模块：

不进行 PII 识别

不修改文本内容

不执行规则

不存储数据

不参与导出逻辑

它仅负责：

选择正确的规则包（routing）。

二、系统位置

语言路由位于输入与规则执行之间。

输入文本
↓
语言路由模块
↓
选择规则包
↓
engine.js 执行对应规则

语言路由是“分发层”，不是“处理层”。

三、实现策略

当前采用：

franc（MIT 许可，基于 n-gram 的纯 JS 语言检测库）

选择原因：

体积轻量

前端可直接使用

支持约 187 种语言

无服务器依赖

无网络通信

可商用（MIT License）

不涉及版权费用

四、检测模型
4.1 输出格式

franc 返回 ISO 语言代码，例如：

eng

deu

cmn

路由模块将其映射为内部规则包标识：

ISO 代码	内部规则包
eng	en
deu	de
cmn	zh

未支持语言将触发人工选择。

五、判定逻辑（锁定流程）

检测流程如下：

1. 使用 franc 检测语言
2. 获取最高得分语言
3. 获取第二名语言
4. 应用阈值与差值规则
自动锁定条件

必须同时满足：

置信度 ≥ 预设阈值（默认 0.75）

第一名与第二名差值 ≥ margin（默认 0.10）

满足条件：

ruleEngine = 检测语言

ruleEngineMode = lock

六、不确定情况处理

若：

置信度不足

差值不足

文本过短

多语言混合明显

系统必须：

不自动切换

默认使用 UI 语言

弹出语言选择窗口

禁止：

静默 fallback

在低置信度下自动锁定

七、UI 设计策略

为避免 UI 复杂化：

不设置常驻语言切换按钮

初始内容跟随 UI 语言

输入后自动检测

若不确定 → 弹窗提示选择

状态区域提供“更改内容语言”入口（单链接）

八、职责隔离原则

语言路由必须与规则系统完全隔离。

强制边界：

engine.js

不得包含语言检测逻辑

不得包含语言关键词

engine.xx.js

不参与语言判断

不控制规则分发

language-router.js

仅负责检测与决策

不包含规则匹配

九、安全模型兼容性

语言路由：

完全前端执行

不发送数据

不存储数据

不违反 D3（无存储原则）

不改变 Raster Secure 输出模型

仅影响规则包选择。

十、扩展策略

新增语言时：

添加新的语言规则包

在路由模块中增加 ISO 映射

无需修改 engine.js

路由层与规则层完全解耦。

十一、可替换性原则

franc 不是不可替换的依赖。

未来可以替换为：

CLD3

自研 n-gram 引擎

服务器端检测（非 v1）

但接口必须保持一致：

detect(text) → { lang, confidence }

实现可变，接口不可变。

十二、设计原则总结

语言检测是“分发问题”，不是“规则问题”。

必须保持：

可替换

可扩展

置信度可控

人工确认兜底

与规则系统解耦

任何将语言判断写入 engine.js 的行为视为架构退化。
