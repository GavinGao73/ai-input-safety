<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Safe Before Send</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a27;
      --text:#e8eefc;
      --muted:#9fb0d0;
      --line:#22324f;
      --accent:#7aa7ff;
      --warn:#ffd166;
      --bad:#ff6b6b;
      --good:#7ef0a8;
      --chip:#1a263d;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8ff;
        --card:#ffffff;
        --text:#0c1222;
        --muted:#52627f;
        --line:#d9e1f2;
        --chip:#f0f4ff;
        --shadow: 0 12px 24px rgba(11,15,23,.08);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:radial-gradient(1200px 600px at 20% -10%, rgba(122,167,255,.25), transparent 60%),
                 radial-gradient(900px 500px at 120% 10%, rgba(126,240,168,.18), transparent 55%),
                 var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 40px}
    .top{
      display:flex;flex-direction:column;gap:10px;margin-bottom:18px
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:linear-gradient(135deg, rgba(122,167,255,.9), rgba(126,240,168,.75));
      box-shadow:var(--shadow);
    }
    h1{font-size:22px;margin:0}
    .slogan{margin:0;color:var(--muted);line-height:1.6}
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .title{font-size:14px;color:var(--muted);letter-spacing:.2px;margin:0}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      background:var(--chip);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
    }
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      letter-spacing:.2px;
    }
    button.primary{
      background:linear-gradient(135deg, rgba(122,167,255,.25), rgba(126,240,168,.18));
      border-color:rgba(122,167,255,.55);
    }
    button.danger{border-color:rgba(255,107,107,.55); color:var(--bad)}
    button:disabled{opacity:.5; cursor:not-allowed}
    textarea{
      width:100%;
      min-height:220px;
      resize:vertical;
      border-radius:14px;
      border:1px solid var(--line);
      background:transparent;
      color:var(--text);
      padding:12px;
      line-height:1.65;
      font-size:14px;
      outline:none;
    }
    .hint{margin:10px 0 0;color:var(--muted);font-size:13px;line-height:1.6}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .kv{display:grid;grid-template-columns: 1fr; gap:10px}
    .box{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:rgba(0,0,0,.06);
    }
    @media (prefers-color-scheme: light){
      .box{background:#f8faff}
    }
    .box h3{margin:0 0 8px;font-size:13px;color:var(--muted)}
    .mono{font-family:var(--mono);font-size:12.5px;white-space:pre-wrap;word-break:break-word;line-height:1.6}
    .riskbar{
      display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap
    }
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      border-radius:999px;padding:6px 10px;
      border:1px solid var(--line);background:var(--chip);
      font-size:12px;color:var(--muted);
    }
    .badge.good{border-color:rgba(126,240,168,.5); color:var(--good)}
    .badge.warn{border-color:rgba(255,209,102,.55); color:var(--warn)}
    .badge.bad{border-color:rgba(255,107,107,.55); color:var(--bad)}
    .list{margin:8px 0 0;padding-left:18px;color:var(--muted);font-size:13px;line-height:1.7}
    .hl{
      padding:1px 4px;border-radius:6px;border:1px solid rgba(255,209,102,.35);
      background:rgba(255,209,102,.16);
    }
    footer{margin-top:14px;color:var(--muted);font-size:12.5px;line-height:1.7}
    .smallnote{color:var(--muted);font-size:12.5px;line-height:1.7;margin:10px 0 0}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(20,30,48,.92);
      border:1px solid rgba(122,167,255,.35);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      box-shadow:var(--shadow);
      font-size:13px;
      opacity:0;pointer-events:none;
      transition:opacity .18s ease;
      max-width:92vw;
    }
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Safe Before Send</h1>
          <p class="slogan">在你把材料交出去之前，先生成一个更安全的版本。</p>
        </div>
      </div>
      <p class="slogan">不登录｜不存储｜不记录内容｜处理仅在本页面内存中完成（刷新/关闭即消失）</p>
    </div>

    <div class="grid">
      <!-- Left: Input -->
      <div class="card">
        <div class="row">
          <p class="title">粘贴原始材料（简历片段 / 文件摘要 / 申请材料等）</p>
          <div class="btns">
            <button id="btnPaste" class="primary">从剪贴板粘贴</button>
            <button id="btnGenerate" class="primary">生成安全版本</button>
            <button id="btnClear" class="danger">清空</button>
          </div>
        </div>

        <textarea id="input" placeholder="把你准备粘贴给 AI / 平台的一段材料放在这里…"></textarea>
        <div class="hint">
          建议：先粘贴，再点击「生成安全版本」。你可以只处理要发送的那一段，不必整份文档。
        </div>

        <div class="divider"></div>

        <div class="row">
          <p class="title">安全版本（可直接粘贴使用）</p>
          <div class="btns">
            <button id="btnCopy" class="primary" disabled>复制安全版本，用于粘贴</button>
          </div>
        </div>

        <div class="box">
          <h3>安全版本预览（已高亮变化）</h3>
          <div id="safePreview" class="mono">（尚未生成）</div>
        </div>

        <p class="smallnote">
          说明：本工具仅做“上传前的最小暴露”处理，不能承诺绝对匿名或零风险；你仍应自行判断是否需要进一步删减。
        </p>
      </div>

      <!-- Right: Risk + Rules -->
      <div class="card">
        <div class="row">
          <p class="title">风险提示（基于当前输入）</p>
          <div class="chips">
            <span class="chip">v1：规则脱敏</span>
            <span class="chip">本地处理</span>
          </div>
        </div>

        <div class="riskbar">
          <span id="badgeLevel" class="badge">风险等级：—</span>
          <span id="badgeCount" class="badge">检测到：0 项</span>
        </div>

        <ul id="riskList" class="list">
          <li>（尚未检测）</li>
        </ul>

        <div class="divider"></div>

        <p class="title">v1 默认替换规则（可理解、可预期）</p>
        <ul class="list">
          <li>邮箱 → <span class="hl">[EMAIL]</span></li>
          <li>手机号/电话 → <span class="hl">[PHONE]</span></li>
          <li>精确日期（如 2024-04-18 / 18.04.2024）→ <span class="hl">[DATE]</span>（保留年份）</li>
          <li>身份证/护照/客户号等长编号 → <span class="hl">[ID]</span></li>
          <li>精确地址片段（含街道号/邮编）→ <span class="hl">[ADDRESS]</span></li>
          <li>银行卡/IBAN（粗略识别）→ <span class="hl">[BANK]</span></li>
        </ul>

        <footer>
          <strong>隐私说明（v1）</strong><br/>
          我们不会记录你输入的内容。为了帮助你判断是否值得继续使用，本页面不内置第三方统计；内容仅在浏览器内存中处理，关闭或刷新即清空。
        </footer>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ---------------------------
    // Minimal, deterministic v1:
    // - No network requests
    // - No storage
    // - Rule-based redaction only
    // ---------------------------

    const $ = (id) => document.getElementById(id);

    const elInput = $("input");
    const elSafePreview = $("safePreview");
    const elRiskList = $("riskList");
    const elBadgeLevel = $("badgeLevel");
    const elBadgeCount = $("badgeCount");

    const btnPaste = $("btnPaste");
    const btnGenerate = $("btnGenerate");
    const btnCopy = $("btnCopy");
    const btnClear = $("btnClear");

    const toast = $("toast");
    let lastSafeText = "";

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.classList.remove("show"), 1600);
    }

    function normalizeText(s){
      return (s || "").replace(/\r\n/g, "\n");
    }

    // Simple redaction rules (v1):
    // Note: We deliberately avoid "name detection" in v1 (too error-prone) and focus on high-signal identifiers.
    const RULES = [
      {
        key: "email",
        label: "邮箱地址",
        pattern: /\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi,
        replace: "[EMAIL]"
      },
      {
        key: "phone",
        label: "手机号/电话",
        // Rough: +49 170 1234567 / 0170-1234567 / (030) 123456
        pattern: /(\+?\d{1,3}[\s-]?)?(\(?\d{2,4}\)?[\s-]?)?\d{3,4}[\s-]?\d{4,}/g,
        replace: "[PHONE]",
        // Guard: avoid replacing small numbers in normal text
        guard: (m) => m.replace(/\D/g,"").length >= 8
      },
      {
        key: "iban",
        label: "银行卡/IBAN（可能）",
        pattern: /\b[A-Z]{2}\d{2}(?:\s?[A-Z0-9]{4}){3,7}\b/gi,
        replace: "[BANK]"
      },
      {
        key: "idlong",
        label: "长编号（护照/身份证/客户号等）",
        // 8-20 mixed alnum
        pattern: /\b[A-Z0-9]{8,20}\b/gi,
        replace: "[ID]",
        guard: (m) => /[A-Z]/i.test(m) && /\d/.test(m)
      },
      {
        key: "dateISO",
        label: "精确日期（YYYY-MM-DD）",
        pattern: /\b(19|20)\d{2}[-\/.](0?[1-9]|1[0-2])[-\/.](0?[1-9]|[12]\d|3[01])\b/g,
        replace: "[DATE]"
      },
      {
        key: "dateEU",
        label: "精确日期（DD.MM.YYYY）",
        pattern: /\b(0?[1-9]|[12]\d|3[01])[.\/-](0?[1-9]|1[0-2])[.\/-]((19|20)\d{2})\b/g,
        replace: "[DATE]"
      },
      {
        key: "postcodeDE",
        label: "邮编（德国 5 位）",
        pattern: /\b\d{5}\b/g,
        replace: "[ADDRESS]"
      },
      {
        key: "streetNo",
        label: "街道门牌（可能）",
        // Rough German/English street with number, e.g. "Musterstraße 12", "Main St 10"
        pattern: /\b([A-Za-zÀ-ž\u4e00-\u9fff]{2,}\s?(straße|str\.|strasse|street|st\.|allee|weg|gasse|platz|ring|road|rd\.|lane|ln\.|avenue|ave\.))\s+\d+[a-zA-Z]?\b/gi,
        replace: "[ADDRESS]"
      }
    ];

    function applyRules(text){
      let redacted = text;
      const hits = [];

      for (const r of RULES){
        redacted = redacted.replace(r.pattern, (match) => {
          if (r.guard && !r.guard(match)) return match;
          hits.push({ key: r.key, label: r.label, value: match });
          return r.replace;
        });
      }

      // Additional: downgrade precise year references? (v1: do nothing)
      return { redacted, hits };
    }

    function dedupeHits(hits){
      // Dedupe by label + value
      const map = new Map();
      for (const h of hits){
        const k = h.label + "||" + h.value;
        if (!map.has(k)) map.set(k, h);
      }
      return Array.from(map.values());
    }

    function riskLevelFromHits(hits){
      // v1 heuristic:
      // - 0 hits => P0 (low)
      // - 1-2 hits => P1 (moderate)
      // - 3-5 hits => P2 (elevated)
      // - 6+ hits => P3 (high)
      // P4 reserved for extremely sensitive content (not detected in v1)
      const n = hits.length;
      if (n === 0) return { level: "P0", cls: "good", text: "风险等级：P0（低）" };
      if (n <= 2) return { level: "P1", cls: "warn", text: "风险等级：P1（中）" };
      if (n <= 5) return { level: "P2", cls: "warn", text: "风险等级：P2（较高）" };
      return { level: "P3", cls: "bad", text: "风险等级：P3（高）" };
    }

    function escapeHtml(s){
      return s.replace(/[&<>"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    function highlightChanges(original, safe){
      // Minimal diff-highlighting: highlight placeholders + segments that changed to placeholders.
      // We keep it deterministic and cheap: mark placeholder tokens as highlighted.
      const escaped = escapeHtml(safe);
      const tokens = ["[EMAIL]","[PHONE]","[DATE]","[ID]","[ADDRESS]","[BANK]"];
      let out = escaped;
      for (const t of tokens){
        const re = new RegExp(escapeRegExp(t), "g");
        out = out.replace(re, `<span class="hl">${t}</span>`);
      }
      return out;
    }
    function escapeRegExp(s){
      return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function renderRisk(hits){
      const deduped = dedupeHits(hits);
      const lvl = riskLevelFromHits(deduped);

      elBadgeLevel.className = "badge " + lvl.cls;
      elBadgeLevel.textContent = lvl.text;

      elBadgeCount.className = "badge";
      elBadgeCount.textContent = "检测到：" + deduped.length + " 项";

      if (deduped.length === 0){
        elRiskList.innerHTML = "<li>未检测到高信号个人识别信息（v1 规则范围内）。</li>";
        return;
      }

      const counts = {};
      for (const h of deduped){
        counts[h.label] = (counts[h.label] || 0) + 1;
      }
      const items = Object.entries(counts)
        .sort((a,b)=>b[1]-a[1])
        .map(([label, c]) => `<li>${escapeHtml(label)}：${c} 处</li>`)
        .join("");

      elRiskList.innerHTML = items;
    }

    async function pasteFromClipboard(){
      try{
        if (!navigator.clipboard || !navigator.clipboard.readText){
          showToast("当前浏览器不支持剪贴板读取，请手动粘贴。");
          return;
        }
        const t = await navigator.clipboard.readText();
        if (!t){
          showToast("剪贴板为空或无可读取文本。");
          return;
        }
        elInput.value = normalizeText(t);
        showToast("已从剪贴板粘贴。");
      } catch (e){
        showToast("无法读取剪贴板（可能需要手动粘贴）。");
      }
    }

    async function copyToClipboard(text){
      try{
        if (!navigator.clipboard || !navigator.clipboard.writeText){
          // Fallback
          const ta = document.createElement("textarea");
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          ta.remove();
          showToast("已复制（兼容模式）。");
          return;
        }
        await navigator.clipboard.writeText(text);
        showToast("已复制安全版本。");
      } catch (e){
        showToast("复制失败，请手动选择复制。");
      }
    }

    function generate(){
      const raw = normalizeText(elInput.value).trim();
      if (!raw){
        showToast("请先粘贴一段材料。");
        return;
      }

      const { redacted, hits } = applyRules(raw);
      lastSafeText = redacted;

      // render preview
      const html = highlightChanges(raw, redacted);
      elSafePreview.innerHTML = html;

      // render risk
      renderRisk(hits);

      btnCopy.disabled = !lastSafeText;
      showToast("已生成安全版本。");
    }

    function clearAll(){
      elInput.value = "";
      lastSafeText = "";
      elSafePreview.textContent = "（尚未生成）";
      elRiskList.innerHTML = "<li>（尚未检测）</li>";
      elBadgeLevel.className = "badge";
      elBadgeLevel.textContent = "风险等级：—";
      elBadgeCount.className = "badge";
      elBadgeCount.textContent = "检测到：0 项";
      btnCopy.disabled = true;
      showToast("已清空。");
    }

    // Events
    btnPaste.addEventListener("click", pasteFromClipboard);
    btnGenerate.addEventListener("click", generate);
    btnClear.addEventListener("click", clearAll);
    btnCopy.addEventListener("click", () => copyToClipboard(lastSafeText));

    // Optional: Auto-detect clipboard on load (ask via user gesture is required in many browsers, so we do NOT auto-read)
    // We keep v1 deterministic and permission-friendly.

  </script>
</body>
</html>
